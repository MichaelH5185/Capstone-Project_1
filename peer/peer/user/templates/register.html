{# peer/templates/template.html #}
{% extends "template.html" %}
{% block content %}
<h2>Register</h2>
<form method="POST" action="">
    {% csrf_token %}
    <label>Username:</label>
    <input type="text" name="username" placeholder="Pick A Username"/>
    <br>
    <label>Email: </label>
    <input type="text" name="email" placeholder="Enter Email"/>
    <br>
    <label>Password: </label>
    <input type="password" name="password" placeholder="Create a Password"/>
    <br>
    <label>Enter Password Again: </label>
    <input type="password" name="password2" placeholder="Re-input the Password"/>
    <br>
    <label>Add Skills to Your Profile (you can add more later):</label>
    <br>
    <select id="item_select" name="skillsList">
        <option value="">-- Select Skills --</option> 
        {%for s in skills %}
        <option value="{{s.id}}" data-name="{{ s.name }}">{{s.name}}</option>
        {%endfor%}
    </select>
    <br>
    <input type="hidden" id="selected_items" name="skills">
    <div id="display_area" style="margin-top: 10px;"></div>
    <button type="submit">Create User</button>
  </form>
  {% if messages %}
  {% for m in messages%}
  <br>
  <p class="error">{{m}}</p>
  {% endfor %}
  {% endif %}
  <script>
    const select = document.getElementById("item_select");
    const hiddenField = document.getElementById("selected_items");
    const display = document.getElementById("display_area");

    function render(items) {
        display.innerHTML = "";

        items.forEach(({id, name}) => {
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.alignItems = "center";
            wrapper.style.marginBottom = "5px";

            const text = document.createElement("span");
            text.textContent = name + " ";
            text.style.marginRight = "10px";

            const removeBtn = document.createElement("button");
            removeBtn.textContent = "x";
            removeBtn.style.cursor = "pointer";
            removeBtn.style.padding = "2px 5px";

            removeBtn.addEventListener("click", () => {
                // Remove from list
                const updated = items.filter(item => item.id !== id);
                hiddenField.value = updated.map(i => i.id).join(",");
                render(updated);
            });

            wrapper.appendChild(text);
            wrapper.appendChild(removeBtn);
            display.appendChild(wrapper);
        });
    }

    select.addEventListener("change", function () {
        const id = this.value;
        if (!id) return;

        const name = this.selectedOptions[0].dataset.name;

        // Parse current list in hidden field
        let items = hiddenField.value
            ? hiddenField.value.split(",").map(x => parseInt(x))
            : [];

        // Avoid duplicates
        if (!items.includes(parseInt(id))) {
            items.push(parseInt(id));
        }

        // Save updated ID list
        hiddenField.value = items.join(",");

        // Convert IDs â†’ {id, name}
        const itemObjects = items.map(i => {
            const opt = document.querySelector(`#item_select option[value="${i}"]`);
            return { id: i, name: opt.dataset.name };
        });

        render(itemObjects);

        this.value = "";
    });
    </script>
{% endblock %}